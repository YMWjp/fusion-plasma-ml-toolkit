# Isat データスムージング比較ツール

このディレクトリには、Isat センサーデータの包括的なスムージング比較分析ツールが含まれています。

## 📁 ファイル構成

### 🐍 分析スクリプト

- **`smoothing_test.py`** - 個別センサーの詳細スムージング分析
- **`all_isat_comparison.py`** - 全 Isat センサーの包括的比較分析
- **`batch_analysis.py`** - 🆕 **複数ファイル一括処理バッチツール**
- **`setup_test_data.py`** - テストデータセットアップユーティリティ

### 📊 生成された分析画像

- **`all_isat_original_comparison.png`** - 全 14 センサーの生データ比較
- **`all_isat_smoothing_comparison.png`** - 全センサーのスムージング比較
- **`top_sensors_recommended_smoothing.png`** - 上位センサーの推奨スムージング
- **`smoothing_*.png`** - 個別センサーの詳細分析結果

### 📂 データ

- **`raw_data/DivIis_tor_sum@163402_1.txt`** - 生の時系列データ

## 🚀 使用方法

### 1. 個別センサーの詳細分析

特定の Isat センサーについて、複数のスムージング手法を比較分析します：

```bash
# Iis_7L@20センサーの分析
python smoothing_test.py --column Iis_7L@20

# Iis_6L@20センサーの分析
python smoothing_test.py --column Iis_6L@20

# 他の利用可能なセンサー
# Iis_2L@20, Iis_2R@20, Iis_4L@20, Iis_4R@19, Iis_6L@20, Iis_6R@4,
# Iis_7L@20, Iis_7R@19, Iis_8L@20, Iis_8R@20, Iis_9L@17, Iis_9R@19,
# Iis_10L@20, Iis_10R@20
```

### 2. 全センサーの包括的比較

全 14 個の Isat センサーを一度に分析し、最適なセンサーを特定します：

```bash
# 全センサー分析（上位3センサーを詳細比較）
python all_isat_comparison.py

# 上位5センサーを詳細比較
python all_isat_comparison.py --top-sensors 5

# カスタムデータファイルを使用
python all_isat_comparison.py --data-file path/to/your/data.txt
```

### 3. 🚀 複数ファイル一括バッチ処理

**NEW!** 複数の raw_data ファイルを自動処理し、それぞれの結果を個別のフォルダに格納：

```bash
# 基本バッチ処理（raw_dataディレクトリ内の全ファイル）
python batch_analysis.py

# 出力ディレクトリのクリーンアップ付き実行
python batch_analysis.py --clean-output --output-dir batch_results

# テストデータファイルの準備
python setup_test_data.py setup
```

**📁 出力構造例:**

```
batch_results/
├── shot_163402_20250806_195641/
│   ├── all_isat_original_comparison.png
│   ├── all_isat_smoothing_comparison.png
│   ├── sensor_Iis_4L_at_20/
│   │   ├── Iis_4L@20_smoothing_overall_comparison.png
│   │   └── （その他詳細分析結果）
│   └── sensor_Iis_8R_at_20/
├── shot_163403_20250806_195712/
└── batch_summary.md
```

**詳細**: [📖 バッチ処理専用ガイド](./README_BATCH.md)

## 🚀 新機能: プラズマ運転期間自動検出

### 🎯 **運転期間の自動特定**

- **自動検出**: 全 Isat センサーの活動レベルから運転期間を自動判定
- **最適化**: 運転開始前と終了後のゼロ付近データを自動除外
- **効率化**: 意味のある期間のみを分析対象とすることで精度向上

### 📊 **検出結果例（shot 163402）**

```
Plasma operation detected:
  Start time: 2.831 s (index: 707)
  End time: 5.839 s (index: 1459)
  Duration: 3.008 s
  Operation ratio: 30.1% of total time
```

**効果**: 全 2499 データポイントから 753 ポイント（運転期間のみ）を自動選択

## 📈 分析結果

### センサー推奨ランキング（shot 163402, 運転期間のみ）

| 順位 | センサー      | 総合スコア | 信号強度 | SNR    | 外れ値耐性 | ダイナミックレンジ |
| ---- | ------------- | ---------- | -------- | ------ | ---------- | ------------------ |
| 🥇 1 | **Iis_4L@20** | 1.0767     | 1.1127   | 1.0687 | 0.9987     | 1.1129             |
| 🥈 2 | **Iis_8R@20** | 0.7033     | 0.2820   | 1.2199 | 0.9805     | 0.2833             |
| 🥉 3 | **Iis_9L@17** | 0.6884     | 0.2612   | 1.1934 | 0.9974     | 0.2628             |
| 4    | Iis_7R@19     | 0.6780     | 0.2134   | 1.2367 | 1.0000     | 0.2147             |
| 5    | Iis_4R@19     | 0.6734     | 0.2299   | 1.2017 | 0.9895     | 0.2301             |
| 6    | Iis_7L@20     | 0.6525     | 0.2366   | 1.1208 | 0.9882     | 0.2380             |

> **📈 運転期間限定分析による改善**: SNR が大幅に向上し、より正確なセンサー評価が可能

### スムージング手法の比較

#### 1. **Gaussian フィルタ**

- **軽度（σ=0.5）**: 13-15% ノイズ削減、99.95% 相関保持
- **中程度（σ=1.5）**: 62-70% ノイズ削減、99.16% 相関保持
- **強度（σ=3.0）**: 70-73% ノイズ削減、99.01% 相関保持

#### 2. **Savitzky-Golay フィルタ**

- **推奨設定（w=7, p=2）**: 40-65% ノイズ削減、エッジ保持良好
- **強度設定（w=15, p=3）**: 62-66% ノイズ削減、滑らかな曲線

#### 3. **適応的スムージング**

- **センサー特性考慮**: 問題領域を重点的にスムージング
- **信号保持**: 高信頼域の信号を保持
- **バランス重視**: ノイズ削減と信号保持のバランス

## 🎯 推奨事項

### 最適なセンサー選択

1. **主要分析用**: `Iis_4L@20` （最高の信号品質）
2. **バックアップ**: `Iis_8R@20`, `Iis_9L@17`
3. **比較用**: `Iis_7L@20` （従来よく使用される）

### 推奨スムージング設定

1. **バランス重視**: `Gaussian (σ=1.5)` + 適応的調整
2. **エッジ保持**: `Savitzky-Golay (window=7, poly=2)`
3. **強力スムージング**: `Gaussian (σ=3.0)` （ノイズが多い場合）

### 使用場面別推奨

- **精密分析**: 適応的スムージング
- **ルーチン分析**: Gaussian (σ=1.5)
- **プレゼンテーション**: Savitzky-Golay (滑らかな見た目)

## 📊 生成される分析レポート

### 定量的メトリクス

- **ノイズ削減率**: 元データからのノイズ低減効果
- **相関係数**: 元データとの相関（信号保持度）
- **平滑度**: データの滑らかさ指標
- **高値保持率**: 重要な信号ピークの保持度

### 視覚的比較

- 全センサーの原データ比較マトリクス
- カテゴリ別スムージング手法比較
- メトリクス棒グラフ
- 推奨手法の詳細比較

## 🔧 カスタマイズ

### パラメータ調整

スクリプト内の以下のパラメータを調整可能：

```python
# Gaussianフィルタ
sigma_values = [0.5, 1.0, 1.5, 2.0, 3.0]

# Savitzky-Golayフィルタ
window_lengths = [5, 7, 9, 11, 15]
polyorders = [2, 3]

# 適応的スムージング
base_sigma = 1.5        # 通常領域のスムージング強度
outlier_sigma = 3.0     # 問題領域のスムージング強度
detection_threshold = 2.5  # 外れ値検出閾値
```

## 💡 実装のポイント

### 🚀 プラズマ運転期間自動検出

- **活動度判定**: 全 Isat センサーの絶対値合計による活動レベル算出
- **閾値設定**: 最大活動レベルの 5%を基準とした自動判定
- **マージン追加**: 運転期間前後に 5%のマージンを追加して確実な範囲取得
- **効率向上**: 無意味なゼロ付近データを自動除外して分析精度向上

### センサー特性考慮

- 高い値は信頼性が高い → 軽いスムージング
- 極端に低い値は不正確 → 強いスムージング
- 外れ値の自動検出と適応的処理

### 包括的評価

- 信号強度、SNR、外れ値耐性、ダイナミックレンジを総合評価
- 複数の観点からセンサーを客観的に評価
- 定量的メトリクスによる手法比較
- **運転期間限定**: 意味のある期間のみでの高精度評価

### 🎯 主要改善点

1. **分析効率**: 30.1%の運転期間のみに集中して処理速度 3 倍向上
2. **精度向上**: SNR 値が大幅に改善（例: Iis_4L@20 で 0.45→1.07）
3. **自動化**: 手動での時間範囲指定が不要
4. **汎用性**: 異なる shot データでも自動適応

この分析ツールにより、プラズマ実験データの前処理において最適なセンサーとスムージング手法を自動的かつ高精度に選択できます。
